<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EAR Pilot — Guida Autonoma</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@400;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #0a0a0f;
            --card: #12121a;
            --delta: #3b82f6;
            --relation: #10b981;
            --process: #ef4444;
            --warning: #f59e0b;
            --text: #f0f0f0;
            --muted: #888;
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 8px;
            gap: 8px;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        
        .logo {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .logo span { opacity: 0.5; }
        
        .connection {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.65rem;
            padding: 4px 10px;
            background: var(--card);
            border-radius: 12px;
        }
        
        .conn-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--process);
        }
        
        .conn-dot.connected { background: var(--relation); }
        
        /* Video Area */
        .video-area {
            position: relative;
            flex: 1;
            min-height: 300px;
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        /* Zone indicators */
        .zones-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            pointer-events: none;
        }
        
        .zone {
            flex: 1;
            border-right: 2px dashed rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 8px;
        }
        
        .zone:last-child { border-right: none; }
        
        .zone-label {
            font-size: 0.6rem;
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 4px;
            border-radius: 4px;
            margin-bottom: 4px;
        }
        
        .zone-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .zone-bar-fill {
            height: 100%;
            background: var(--process);
            transition: width 0.15s;
        }
        
        /* Command display */
        .command-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(0,0,0,0.8);
            opacity: 0.9;
        }
        
        .cmd-forward { color: var(--relation); }
        .cmd-back { color: var(--warning); }
        .cmd-left { color: var(--delta); }
        .cmd-right { color: var(--delta); }
        .cmd-stop { color: var(--process); }
        
        /* HUD */
        .hud-top {
            position: absolute;
            top: 8px; left: 8px; right: 8px;
            display: flex;
            justify-content: space-between;
            font-size: 0.6rem;
        }
        
        .hud-item {
            background: rgba(0,0,0,0.7);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .control-card {
            background: var(--card);
            border-radius: 10px;
            padding: 12px;
        }
        
        .control-card h4 {
            font-size: 0.55rem;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        /* Mode selector */
        .mode-btns {
            display: flex;
            gap: 4px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.7rem;
            font-family: inherit;
            background: rgba(255,255,255,0.05);
            color: var(--text);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mode-btn.active {
            border-color: var(--relation);
            background: rgba(16, 185, 129, 0.1);
        }
        
        /* Steering display */
        .steering {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .steering-bar {
            flex: 1;
            height: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            position: relative;
        }
        
        .steering-center {
            position: absolute;
            top: 0; bottom: 0;
            left: 50%;
            width: 2px;
            background: rgba(255,255,255,0.3);
        }
        
        .steering-indicator {
            position: absolute;
            top: 2px; bottom: 2px;
            width: 20px;
            background: var(--delta);
            border-radius: 3px;
            left: calc(50% - 10px);
            transition: left 0.1s;
        }
        
        .steering-value {
            width: 40px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        /* Speed control */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .speed-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            outline: none;
        }
        
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--relation);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .speed-value {
            width: 40px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        /* Connection panel */
        .conn-panel {
            grid-column: span 2;
        }
        
        .conn-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .conn-input {
            flex: 1;
            padding: 8px;
            font-family: inherit;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--text);
        }
        
        .conn-btn {
            padding: 8px 16px;
            font-family: inherit;
            font-size: 0.75rem;
            background: var(--delta);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .conn-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .conn-status {
            font-size: 0.65rem;
            color: var(--muted);
        }
        
        /* EAR Meters mini */
        .ear-mini {
            display: flex;
            gap: 12px;
        }
        
        .ear-item {
            flex: 1;
            text-align: center;
        }
        
        .ear-symbol {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .ear-symbol.delta { color: var(--delta); }
        .ear-symbol.relation { color: var(--relation); }
        .ear-symbol.process { color: var(--process); }
        
        .ear-value {
            font-size: 0.7rem;
            color: var(--muted);
        }
        
        /* Start overlay */
        .start-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10,10,15,0.97);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
            text-align: center;
        }
        
        .start-overlay.hidden { display: none; }
        
        .start-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--delta), var(--process));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .start-sub {
            color: var(--muted);
            margin-bottom: 24px;
        }
        
        .start-btn {
            padding: 14px 40px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--delta), var(--process));
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .loading {
            margin-top: 16px;
            color: var(--muted);
            font-size: 0.8rem;
        }
        
        .loading.hidden { display: none; }
    </style>
</head>
<body>
    <div class="start-overlay" id="startOverlay">
        <div class="start-title">EAR PILOT</div>
        <div class="start-sub">Guida Autonoma con Visione EAR</div>
        <button class="start-btn" id="startBtn">AVVIA</button>
        <div class="loading hidden" id="loading">Accesso camera...</div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="logo">EAR <span>PILOT</span></div>
            <div class="connection">
                <div class="conn-dot" id="connDot"></div>
                <span id="connText">Non connesso</span>
            </div>
        </div>
        
        <div class="video-area">
            <video id="video" playsinline autoplay muted></video>
            <canvas id="overlay"></canvas>
            
            <div class="zones-overlay">
                <div class="zone" id="zoneLeft">
                    <div class="zone-label">SX</div>
                    <div class="zone-bar"><div class="zone-bar-fill" id="zoneBarLeft"></div></div>
                </div>
                <div class="zone" id="zoneCenter">
                    <div class="zone-label">CENTRO</div>
                    <div class="zone-bar"><div class="zone-bar-fill" id="zoneBarCenter"></div></div>
                </div>
                <div class="zone" id="zoneRight">
                    <div class="zone-label">DX</div>
                    <div class="zone-bar"><div class="zone-bar-fill" id="zoneBarRight"></div></div>
                </div>
            </div>
            
            <div class="command-display" id="cmdDisplay">—</div>
            
            <div class="hud-top">
                <div class="hud-item" id="fps">-- fps</div>
                <div class="hud-item">K: <span id="kValue">0.000</span></div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-card">
                <h4>Modalità</h4>
                <div class="mode-btns">
                    <button class="mode-btn active" id="modeAuto">AUTO</button>
                    <button class="mode-btn" id="modeManual">MANUAL</button>
                </div>
            </div>
            
            <div class="control-card">
                <h4>Sterzo</h4>
                <div class="steering">
                    <div class="steering-bar">
                        <div class="steering-center"></div>
                        <div class="steering-indicator" id="steerIndicator"></div>
                    </div>
                    <div class="steering-value" id="steerValue">0°</div>
                </div>
            </div>
            
            <div class="control-card">
                <h4>Velocità Max</h4>
                <div class="speed-control">
                    <input type="range" class="speed-slider" id="speedSlider" min="50" max="255" value="150">
                    <div class="speed-value" id="speedValue">150</div>
                </div>
            </div>
            
            <div class="control-card">
                <h4>EAR Totale</h4>
                <div class="ear-mini">
                    <div class="ear-item">
                        <div class="ear-symbol delta">Δ</div>
                        <div class="ear-value" id="earDelta">0%</div>
                    </div>
                    <div class="ear-item">
                        <div class="ear-symbol relation">⇄</div>
                        <div class="ear-value" id="earRelation">0%</div>
                    </div>
                    <div class="ear-item">
                        <div class="ear-symbol process">⟳</div>
                        <div class="ear-value" id="earProcess">0%</div>
                    </div>
                </div>
            </div>
            
            <div class="control-card conn-panel">
                <h4>Connessione Arduino (WebSocket)</h4>
                <div class="conn-row">
                    <input type="text" class="conn-input" id="wsUrl" placeholder="ws://192.168.x.x:81" value="ws://192.168.4.1:81">
                    <button class="conn-btn" id="connectBtn">Connetti</button>
                </div>
                <div class="conn-status" id="connStatus">Inserisci IP dell'ESP32 e premi Connetti</div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // EAR PILOT v4 - Autonomous RC Car Controller
        // ============================================
        
        const CONFIG = {
            MOTION_THRESHOLD: 20,
            UPDATE_INTERVAL: 80,
            SMOOTHING: 0.3,
            ANALYSIS_SCALE: 0.35,  // Qualità più alta
            K_CRIT: 0.35,
            // Soglie guida
            OBSTACLE_THRESHOLD: 0.15,  // ⟳ > 15% = ostacolo
            CLEAR_THRESHOLD: 0.05,     // ⟳ < 5% = libero
            STEER_GAIN: 2.0
        };
        
        // Stato
        let isRunning = false;
        let isAutoMode = true;
        let previousFrame = null;
        let currentEAR = { delta: 0.33, relation: 0.33, process: 0.33 };
        let lastEAR = { ...currentEAR };
        let zoneMotion = { left: 0, center: 0, right: 0 };
        let currentCommand = 'S';
        let currentSteering = 0;
        let maxSpeed = 150;
        let ws = null;
        let frameCount = 0;
        let lastFpsTime = Date.now();
        
        // DOM
        const el = {
            startOverlay: document.getElementById('startOverlay'),
            startBtn: document.getElementById('startBtn'),
            loading: document.getElementById('loading'),
            video: document.getElementById('video'),
            overlay: document.getElementById('overlay'),
            fps: document.getElementById('fps'),
            kValue: document.getElementById('kValue'),
            cmdDisplay: document.getElementById('cmdDisplay'),
            zoneBarLeft: document.getElementById('zoneBarLeft'),
            zoneBarCenter: document.getElementById('zoneBarCenter'),
            zoneBarRight: document.getElementById('zoneBarRight'),
            steerIndicator: document.getElementById('steerIndicator'),
            steerValue: document.getElementById('steerValue'),
            speedSlider: document.getElementById('speedSlider'),
            speedValue: document.getElementById('speedValue'),
            earDelta: document.getElementById('earDelta'),
            earRelation: document.getElementById('earRelation'),
            earProcess: document.getElementById('earProcess'),
            modeAuto: document.getElementById('modeAuto'),
            modeManual: document.getElementById('modeManual'),
            wsUrl: document.getElementById('wsUrl'),
            connectBtn: document.getElementById('connectBtn'),
            connStatus: document.getElementById('connStatus'),
            connDot: document.getElementById('connDot'),
            connText: document.getElementById('connText')
        };
        
        // Canvas elaborazione
        const processCanvas = document.createElement('canvas');
        const processCtx = processCanvas.getContext('2d', { willReadFrequently: true });
        
        // Event listeners
        el.startBtn.addEventListener('click', startApp);
        el.modeAuto.addEventListener('click', () => setMode(true));
        el.modeManual.addEventListener('click', () => setMode(false));
        el.speedSlider.addEventListener('input', () => {
            maxSpeed = parseInt(el.speedSlider.value);
            el.speedValue.textContent = maxSpeed;
        });
        el.connectBtn.addEventListener('click', toggleConnection);
        
        function setMode(auto) {
            isAutoMode = auto;
            el.modeAuto.classList.toggle('active', auto);
            el.modeManual.classList.toggle('active', !auto);
            if (!auto) {
                sendCommand('S');
            }
        }
        
        async function startApp() {
            el.startBtn.style.display = 'none';
            el.loading.classList.remove('hidden');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                el.video.srcObject = stream;
                await el.video.play();
                
                const w = el.video.videoWidth;
                const h = el.video.videoHeight;
                
                el.overlay.width = w;
                el.overlay.height = h;
                
                processCanvas.width = Math.floor(w * CONFIG.ANALYSIS_SCALE);
                processCanvas.height = Math.floor(h * CONFIG.ANALYSIS_SCALE);
                
                el.startOverlay.classList.add('hidden');
                
                isRunning = true;
                requestAnimationFrame(mainLoop);
                
            } catch (err) {
                el.loading.textContent = 'Errore: ' + err.message;
            }
        }
        
        function mainLoop() {
            if (!isRunning) return;
            
            // Cattura frame
            processCtx.drawImage(el.video, 0, 0, processCanvas.width, processCanvas.height);
            const currentFrame = processCtx.getImageData(0, 0, processCanvas.width, processCanvas.height);
            
            if (previousFrame) {
                // Analizza movimento per zone
                const result = analyzeMotionZones(previousFrame, currentFrame);
                
                // Smooth EAR totale
                currentEAR.delta = lerp(currentEAR.delta, result.total.delta, CONFIG.SMOOTHING);
                currentEAR.relation = lerp(currentEAR.relation, result.total.relation, CONFIG.SMOOTHING);
                currentEAR.process = lerp(currentEAR.process, result.total.process, CONFIG.SMOOTHING);
                
                // Smooth zone motion
                zoneMotion.left = lerp(zoneMotion.left, result.zones.left, CONFIG.SMOOTHING);
                zoneMotion.center = lerp(zoneMotion.center, result.zones.center, CONFIG.SMOOTHING);
                zoneMotion.right = lerp(zoneMotion.right, result.zones.right, CONFIG.SMOOTHING);
                
                // Calcola K
                const k = calculateK(lastEAR, currentEAR);
                
                // Guida autonoma
                if (isAutoMode) {
                    const cmd = computeDriveCommand();
                    if (cmd.command !== currentCommand) {
                        currentCommand = cmd.command;
                        sendCommand(currentCommand);
                    }
                    currentSteering = cmd.steering;
                }
                
                // UI
                updateUI(k);
                drawOverlay(result.motionMap);
                
                lastEAR = { ...currentEAR };
            }
            
            previousFrame = currentFrame;
            
            // FPS
            frameCount++;
            if (Date.now() - lastFpsTime > 1000) {
                el.fps.textContent = frameCount + ' fps';
                frameCount = 0;
                lastFpsTime = Date.now();
            }
            
            setTimeout(() => requestAnimationFrame(mainLoop), CONFIG.UPDATE_INTERVAL);
        }
        
        function analyzeMotionZones(prev, curr) {
            const w = prev.width;
            const h = prev.height;
            const total = w * h;
            const zoneWidth = Math.floor(w / 3);
            
            const motionMap = new Uint8Array(total);
            const zoneCounts = { left: 0, center: 0, right: 0 };
            const zonePixels = { left: 0, center: 0, right: 0 };
            let deltaCount = 0, processCount = 0, relationCount = 0;
            
            // Pass 1: Detect motion
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const i = y * w + x;
                    const idx = i * 4;
                    
                    const prevLum = prev.data[idx] * 0.299 + prev.data[idx+1] * 0.587 + prev.data[idx+2] * 0.114;
                    const currLum = curr.data[idx] * 0.299 + curr.data[idx+1] * 0.587 + curr.data[idx+2] * 0.114;
                    const diff = Math.abs(currLum - prevLum);
                    
                    // Determina zona
                    let zone;
                    if (x < zoneWidth) zone = 'left';
                    else if (x < zoneWidth * 2) zone = 'center';
                    else zone = 'right';
                    
                    zonePixels[zone]++;
                    
                    if (diff > CONFIG.MOTION_THRESHOLD) {
                        motionMap[i] = 1;
                        processCount++;
                        zoneCounts[zone]++;
                    } else {
                        motionMap[i] = 0;
                        deltaCount++;
                    }
                }
            }
            
            // Pass 2: Find edges
            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    const i = y * w + x;
                    if (motionMap[i] === 0) {
                        // Check neighbors
                        if (motionMap[i-1] === 1 || motionMap[i+1] === 1 ||
                            motionMap[i-w] === 1 || motionMap[i+w] === 1) {
                            motionMap[i] = 2;
                            relationCount++;
                            deltaCount--;
                        }
                    }
                }
            }
            
            return {
                total: {
                    delta: deltaCount / total,
                    relation: relationCount / total,
                    process: processCount / total
                },
                zones: {
                    left: zoneCounts.left / zonePixels.left,
                    center: zoneCounts.center / zonePixels.center,
                    right: zoneCounts.right / zonePixels.right
                },
                motionMap
            };
        }
        
        function computeDriveCommand() {
            const L = zoneMotion.left;
            const C = zoneMotion.center;
            const R = zoneMotion.right;
            
            let command = 'F';
            let steering = 0;
            
            // Ostacolo centrale → STOP
            if (C > CONFIG.OBSTACLE_THRESHOLD * 1.5) {
                command = 'S';
                steering = 0;
            }
            // Ostacolo a destra → SINISTRA
            else if (R > CONFIG.OBSTACLE_THRESHOLD && R > L * 1.5) {
                command = 'L';
                steering = -Math.min((R - L) * CONFIG.STEER_GAIN * 100, 45);
            }
            // Ostacolo a sinistra → DESTRA
            else if (L > CONFIG.OBSTACLE_THRESHOLD && L > R * 1.5) {
                command = 'R';
                steering = Math.min((L - R) * CONFIG.STEER_GAIN * 100, 45);
            }
            // Via libera → AVANTI
            else if (C < CONFIG.CLEAR_THRESHOLD && L < CONFIG.OBSTACLE_THRESHOLD && R < CONFIG.OBSTACLE_THRESHOLD) {
                command = 'F';
                // Leggera correzione verso il lato più libero
                steering = (R - L) * CONFIG.STEER_GAIN * 30;
            }
            // Situazione incerta → rallenta
            else {
                command = 'F';
                steering = (R - L) * CONFIG.STEER_GAIN * 50;
            }
            
            return { command, steering: Math.round(steering) };
        }
        
        function drawOverlay(motionMap) {
            const ctx = el.overlay.getContext('2d');
            const w = processCanvas.width;
            const h = processCanvas.height;
            const cw = el.overlay.width;
            const ch = el.overlay.height;
            
            ctx.clearRect(0, 0, cw, ch);
            
            // Disegna motion map (ottimizzato)
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = w;
            tempCanvas.height = h;
            const tempCtx = tempCanvas.getContext('2d');
            const imgData = tempCtx.createImageData(w, h);
            
            for (let i = 0; i < motionMap.length; i++) {
                const idx = i * 4;
                if (motionMap[i] === 1) {
                    imgData.data[idx] = 239;
                    imgData.data[idx+1] = 68;
                    imgData.data[idx+2] = 68;
                    imgData.data[idx+3] = 80;
                } else if (motionMap[i] === 2) {
                    imgData.data[idx] = 16;
                    imgData.data[idx+1] = 185;
                    imgData.data[idx+2] = 129;
                    imgData.data[idx+3] = 100;
                }
            }
            
            tempCtx.putImageData(imgData, 0, 0);
            ctx.drawImage(tempCanvas, 0, 0, cw, ch);
        }
        
        function updateUI(k) {
            // Zone bars
            el.zoneBarLeft.style.width = (zoneMotion.left * 100 / 0.3) + '%';
            el.zoneBarCenter.style.width = (zoneMotion.center * 100 / 0.3) + '%';
            el.zoneBarRight.style.width = (zoneMotion.right * 100 / 0.3) + '%';
            
            // K value
            el.kValue.textContent = k.toFixed(3);
            
            // Command display
            const cmdSymbols = { F: '↑', B: '↓', L: '←', R: '→', S: '■' };
            const cmdClasses = { F: 'cmd-forward', B: 'cmd-back', L: 'cmd-left', R: 'cmd-right', S: 'cmd-stop' };
            el.cmdDisplay.textContent = cmdSymbols[currentCommand] || '—';
            el.cmdDisplay.className = 'command-display ' + (cmdClasses[currentCommand] || '');
            
            // Steering
            const steerPct = 50 + (currentSteering / 90 * 50);
            el.steerIndicator.style.left = `calc(${steerPct}% - 10px)`;
            el.steerValue.textContent = currentSteering + '°';
            
            // EAR totale
            el.earDelta.textContent = Math.round(currentEAR.delta * 100) + '%';
            el.earRelation.textContent = Math.round(currentEAR.relation * 100) + '%';
            el.earProcess.textContent = Math.round(currentEAR.process * 100) + '%';
        }
        
        function calculateK(prev, curr) {
            const dD = curr.delta - prev.delta;
            const dR = curr.relation - prev.relation;
            const dP = curr.process - prev.process;
            return Math.sqrt(dD*dD + dR*dR + dP*dP);
        }
        
        function lerp(a, b, t) {
            return a + (b - a) * t;
        }
        
        // WebSocket connection
        function toggleConnection() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            } else {
                connectWebSocket();
            }
        }
        
        function connectWebSocket() {
            const url = el.wsUrl.value;
            el.connStatus.textContent = 'Connessione a ' + url + '...';
            el.connectBtn.disabled = true;
            
            try {
                ws = new WebSocket(url);
                
                ws.onopen = () => {
                    el.connStatus.textContent = 'Connesso!';
                    el.connDot.classList.add('connected');
                    el.connText.textContent = 'Connesso';
                    el.connectBtn.textContent = 'Disconnetti';
                    el.connectBtn.disabled = false;
                };
                
                ws.onclose = () => {
                    el.connStatus.textContent = 'Disconnesso';
                    el.connDot.classList.remove('connected');
                    el.connText.textContent = 'Non connesso';
                    el.connectBtn.textContent = 'Connetti';
                    el.connectBtn.disabled = false;
                };
                
                ws.onerror = (err) => {
                    el.connStatus.textContent = 'Errore connessione';
                    el.connectBtn.disabled = false;
                };
                
                ws.onmessage = (msg) => {
                    console.log('Arduino:', msg.data);
                };
                
            } catch (err) {
                el.connStatus.textContent = 'Errore: ' + err.message;
                el.connectBtn.disabled = false;
            }
        }
        
        function sendCommand(cmd) {
            const speed = (cmd === 'F' || cmd === 'B') ? maxSpeed : Math.round(maxSpeed * 0.7);
            const message = cmd === 'S' ? 'S' : `${cmd}:${speed}`;
            
            console.log('Command:', message);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
            }
        }
        
        // Manual controls (touch/keyboard)
        document.addEventListener('keydown', (e) => {
            if (!isAutoMode) {
                const keyMap = { ArrowUp: 'F', ArrowDown: 'B', ArrowLeft: 'L', ArrowRight: 'R', Space: 'S' };
                const cmd = keyMap[e.code];
                if (cmd) {
                    currentCommand = cmd;
                    sendCommand(cmd);
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (!isAutoMode) {
                currentCommand = 'S';
                sendCommand('S');
            }
        });
    </script>
</body>
</html>
